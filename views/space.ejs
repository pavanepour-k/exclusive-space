<!DOCTYPE html>
<html lang="<%= lang %>">
<head>
  <%- include('partials/head') %>
</head>
<body class="min-h-screen flex flex-col">
  <%- include('partials/nav') %>
  <main class="container mx-auto p-4 flex-1">
    <h1 class="text-2xl mb-4"><%= t('exclusive_space') %></h1>
    <div id="messages" class="space-y-2 mb-4">
      <% space.messages.forEach(m => { %>
        <div>
          <strong><%= m.sender.displayName %>:</strong>
          <% if(m.type === 'text'){ %>
            <span><%= m.text %></span>
          <% } else { %>
            <audio controls src="<%= m.audioUrl %>"></audio>
          <% } %>
        </div>
      <% }) %>
    </div>
    <form action="/spaces/<%= space.id %>/message" method="post" class="flex gap-2 mb-4">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>"/>
      <input name="text" class="border flex-1 p-2"/>
      <button class="bg-blue-600 text-white px-4 py-2"><%= t('send') %></button>
    </form>
    <form action="/spaces/<%= space.id %>/audio" method="post" enctype="multipart/form-data" class="mb-4 space-x-2">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>"/>
      <input type="file" name="audio" accept="audio/*" class="border p-2" />
      <button class="bg-blue-600 text-white px-4 py-2"><%= t('record') %></button>
    </form>
    <h2 class="text-xl mb-2"><%= t('couple_album') %></h2>
    <form action="/spaces/<%= space.id %>/photo" method="post" enctype="multipart/form-data" class="mb-4 space-y-2">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>"/>
      <input type="file" name="photo" accept="image/*" class="border p-2" />
      <input name="caption" class="border w-full p-2" placeholder="<%= t('caption') %>"/>
      <button class="bg-blue-600 text-white px-4 py-2"><%= t('upload_photo') %></button>
    </form>
    <div class="grid grid-cols-2 gap-4">
      <% space.photos.forEach(p => { %>
        <div>
          <img src="<%= p.url %>" alt="<%= p.caption || '' %>" class="w-full h-auto"/>
          <p><%= p.caption %></p>
          <% if(p.uploaderId === user.id){ %>
            <form action="/uploads/photo/<%= p.id %>/delete" method="post">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>"/>
              <button class="text-red-600 underline"><%= t('delete') %></button>
            </form>
          <% } %>
        </div>
      <% }) %>
    </div>
  </main>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    socket.emit('join-space', { spaceId: '<%= space.id %>' });
    socket.on('new-message', msg => {
      const div = document.createElement('div');
      const name = msg.sender.displayName;
      if(msg.type === 'text'){
        div.innerHTML = `<strong>${name}:</strong> <span>${msg.text}</span>`;
      } else {
        div.innerHTML = `<strong>${name}:</strong> <audio controls src="${msg.audioUrl}"></audio>`;
      }
      document.getElementById('messages').appendChild(div);
    });
  </script>
</body>
</html>